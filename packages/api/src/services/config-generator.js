/**
 * OpenClaw Config Generator
 *
 * Generates complete OpenClaw configuration from Winston tenant data
 * Outputs: openclaw.json, SOUL.md, AGENTS.md, USER.md, IDENTITY.md
 */

const fs = require('fs').promises;
const path = require('path');
const crypto = require('crypto');

/**
 * Generate all config files for a tenant
 *
 * @param {Object} tenant - Tenant record from database
 * @param {Object} options - Additional configuration options
 * @returns {Object} Generated config files
 */
async function generateTenantConfig(tenant, options = {}) {
  const {
    agentName = 'Sage',
    personality = 'Friendly and knowledgeable cannabis retail assistant',
    tone = 'casual',
    capabilities = [],
    channels = { telegram: false, slack: false, whatsapp: false, webchat: true },
    telegramBotToken = null
  } = options;

  // Generate gateway token
  const gatewayToken = crypto.randomBytes(32).toString('hex');

  // Load baseline config template
  const baseConfigPath = path.join(__dirname, '../templates/openclaw-base.json');
  const baseConfig = JSON.parse(await fs.readFile(baseConfigPath, 'utf-8'));

  // Substitute variables in openclaw.json
  let openclawConfig = JSON.stringify(baseConfig, null, 2);

  const variables = {
    '{{TENANT_ID}}': tenant.id,
    '{{TIER}}': tenant.tier,
    '{{GATEWAY_TOKEN}}': gatewayToken,
    '{{LLM_PROXY_URL}}': process.env.LLM_PROXY_URL || 'http://localhost:3002',
    '{{SELECTED_MODEL}}': tenant.selected_model || 'kimi-k2.5',
    '"{{TELEGRAM_ENABLED}}"': channels.telegram.toString(),
    '{{TELEGRAM_BOT_TOKEN}}': telegramBotToken || '',
    '"{{SLACK_ENABLED}}"': channels.slack.toString(),
    '"{{WHATSAPP_ENABLED}}"': channels.whatsapp.toString()
  };

  for (const [key, value] of Object.entries(variables)) {
    openclawConfig = openclawConfig.replace(new RegExp(key, 'g'), value);
  }

  // Load SOUL.md template
  const soulTemplatePath = path.join(__dirname, '../templates/soul-dispensary.md');
  let soulMd = await fs.readFile(soulTemplatePath, 'utf-8');

  // Substitute SOUL.md variables
  const soulVariables = {
    '{{AGENT_NAME}}': agentName,
    '{{BUSINESS_NAME}}': tenant.name,
    '{{PERSONALITY_DESCRIPTION}}': personality,
    '{{TONE}}': tone,
    '{{LOCATION}}': tenant.location || 'Your area',
    '{{HOURS}}': tenant.hours || 'Check website for hours',
    '{{WEBSITE_URL}}': tenant.website_url || '',
    '{{CUSTOM_CAPABILITIES}}': capabilities.join(', '),
    '{{DASHBOARD_URL}}': process.env.WINSTON_WEB_URL || 'http://localhost:3000',
    '{{NEXT_REFRESH_DATE}}': new Date(tenant.credits_refresh_date).toLocaleDateString()
  };

  for (const [key, value] of Object.entries(soulVariables)) {
    soulMd = soulMd.replace(new RegExp(key, 'g'), value);
  }

  // Generate AGENTS.md
  const agentsMd = generateAgentsMd(agentName, capabilities);

  // Generate USER.md
  const userMd = generateUserMd(tenant);

  // Generate IDENTITY.md
  const identityMd = generateIdentityMd(agentName, tone);

  return {
    'openclaw.json': openclawConfig,
    'SOUL.md': soulMd,
    'AGENTS.md': agentsMd,
    'USER.md': userMd,
    'IDENTITY.md': identityMd,
    gatewayToken
  };
}

function generateAgentsMd(agentName, capabilities) {
  return `# AGENTS.md

## Available Agents

### ${agentName}

**Description:** Primary assistant agent for customer and staff interactions.

**Capabilities:**
${capabilities.length > 0 ? capabilities.map(c => `- ${c}`).join('\n') : '- General assistance\n- Information lookup\n- Conversation'}

**Model:** Configured via tenant settings (see openclaw.json)

**Tools:** Read-only by default. See SOUL.md for available skills.

**Channels:** Configured via tenant dashboard.
`;
}

function generateUserMd(tenant) {
  return `# USER.md

## Business Information

**Name:** ${tenant.name}

**Industry:** ${tenant.industry || 'Cannabis Retail'}

**Website:** ${tenant.website_url || 'Not provided'}

**Contact Email:** ${tenant.email}

**Status:** ${tenant.status}

**Subscription:** ${tenant.tier.charAt(0).toUpperCase() + tenant.tier.slice(1)} plan

---

*This file is auto-generated by Winston. Updates should be made through the tenant dashboard.*
`;
}

function generateIdentityMd(agentName, tone) {
  const emoji = tone === 'formal' ? 'ðŸŽ“' : tone === 'casual' ? 'âœ¨' : 'ðŸŒ¿';

  return `# IDENTITY.md

## Agent Identity

**Name:** ${agentName}

**Emoji:** ${emoji}

**Vibe:** ${tone.charAt(0).toUpperCase() + tone.slice(1)}

**Pronouns:** they/them (neutral by default)

---

*This represents how the agent introduces itself and appears in chat interfaces.*
`;
}

/**
 * Write config files to disk
 *
 * @param {string} outputDir - Directory to write files to
 * @param {Object} configs - Generated config files
 */
async function writeConfigFiles(outputDir, configs) {
  await fs.mkdir(outputDir, { recursive: true });

  for (const [filename, content] of Object.entries(configs)) {
    if (filename === 'gatewayToken') continue;
    const filepath = path.join(outputDir, filename);
    await fs.writeFile(filepath, content, 'utf-8');
    console.log(`âœ… Written: ${filepath}`);
  }
}

// CLI test
if (require.main === module) {
  const testTenant = {
    id: '53eb6054-4c8d-442c-a9c7-9ce7970b9376',
    name: 'Test Dispensary',
    email: 'test@example.com',
    tier: 'free',
    selected_model: 'claude-sonnet-4-5',
    website_url: 'https://example.com',
    status: 'active',
    credits_refresh_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
  };

  const options = {
    agentName: 'Bud',
    personality: 'Friendly and knowledgeable cannabis assistant. Warm and approachable.',
    tone: 'casual',
    capabilities: [
      'Check product inventory',
      'Answer strain questions',
      'Provide product recommendations'
    ],
    channels: {
      telegram: true,
      slack: false,
      whatsapp: false,
      webchat: true
    },
    telegramBotToken: 'test-token-here'
  };

  (async () => {
    console.log('Generating test config...\n');
    const configs = await generateTenantConfig(testTenant, options);
    const outputDir = path.join(__dirname, '../../../test-config');
    await writeConfigFiles(outputDir, configs);
    console.log(`\nâœ… Config generated in: ${outputDir}`);
    console.log(`ðŸ”‘ Gateway token: ${configs.gatewayToken}`);
  })();
}

module.exports = { generateTenantConfig, writeConfigFiles };
